<?php

    namespace App\Http\Controllers;

    use Illuminate\Http\Request;
    use Illuminate\Support\Str;

    use App\Http\Requests;
    use App\Dentist;
    use App\Nationality;
    use App\Hospital;
    use Auth;
    use Session;
    use Route;
    use Carbon\Carbon;
    use DB;
    use Illuminate\Support\Facades\Mail;
    use App\Mail\ForgetPassword;

    class ApiDentistController extends Controller
    {


        public function logout (Request $request)
        {
            auth('dapi')->logout();
            return response()->json(['Logout successefuly']);

        }

        public function Login (Request $request)
        {
            if (Auth::guard('dentist')->attempt(['mobile' => $request->mobile, 'password' => $request->password, 'active' => '1'])) {
                //Auth::user();
                //  Auth::guard('admin')->user();
                $dentist = Dentist::where('mobile', $request->mobile)->first();

                $dentist->device_id = $request->device_id;

                $dentist->update();
                return response()->json(['status' => 'Login successefuly', 'data' => $dentist]);

            } else {

                return response()->json(['Error']);

            }
        }

        public function deleteDevice (Request $request)
        {

            /* $dentist = Dentist::where('id', $request->dentis_id)->first();

                    $dentist->device_id = "";

                    $dentist->update();*/
            $device_id = "";
            $update = DB::table('dentists')
                ->where('id', $request->dentist_id)
                ->update(['device_id' => $device_id]);
            //var_dump($update);
            return response()->json(['status' => 'success']);


        }

        public function registerAction (Request $request)
        {
            $dentist_check = Dentist::where('mobile', $request->mobile)
                ->where('active', 0)->first();
            if ($dentist_check) {
                Dentist::where('mobile', $request->mobile)
                    ->where('active', 0)->first()->delete();
            }


            $this->validate($request,
                [
                    'name' => 'required|string|max:255',

                    'mobile' => 'required|numeric|regex:/(05)[0-9]{8}/|unique:dentists',
                    'nation_id' => 'required|digits:10|numeric|regex:/(1)[0-9]{9}/',

                    'email' => 'required|string|email|max:255|unique:dentists',
                    'password' => 'required|string|min:6|confirmed',
                    'dgree' => 'required|numeric',
                    'birthdate' => 'required|date',
                    'photo' => 'image|mimes:jpeg,png,jpg,gif,svg'


                ]);
            if ($request->password === $request->password_confirmation) {

                $result = '';
                for ($i = 0; $i < 4; $i++) {
                    $result .= mt_rand(0, 9);
                }
                $len = 5;
                $txt = "";
                $str = '0123456789';
                for ($i = 0; $i < $len; $i++) {
                    //   $txt .=substr($str, rand(0, strlen($str)), 1);
                    $txt .= mt_rand(0, 9);
                }
                //  $result='1234';
                //ABCDEFGHIJKLMNOPQRSTUVWXYZ
                $client = new Dentist;
                $client->name = $request->name;
                $client->en_name = $request->en_name;
                $client->email = $request->email;
                $client->mobile = $request->mobile;
                $client->nationality = $request->nationality;
                $client->gender = $request->gender;
                $client->nation_id = $request->nation_id;
                $client->dgree = $request->dgree;
                $client->hospital = $request->hospital;
                $client->device_id = $request->device_id;
                $client->birthdate = Carbon::parse($request->birthdate)->format('Y-m-d');
                $client->password = bcrypt($request->password);
                $client->otp = $result;
                $client->code = $txt;
                $client->api_token = Str::random(60);


                if ($request->photo) {
                    $name = time() . '.' . $request->photo->getClientOriginalExtension();
                    $request->photo->move(public_path('/images'), $name);
                    $client->photo = $name;
                }
                if ($request->profile_photo) {
                    $name = time() . '.' . $request->profile_photo->getClientOriginalExtension();
                    $request->profile_photo->move(public_path('/images'), $name);
                    $client->profile_photo = $name;
                }
                $client->save();
                if ($client) {
                    //	echo 'd';
                    //    Auth::guard('dentist')->attempt(['mobile' => $request->mobile,'password' => $request->password ]);
                    //echo $result;
                    $message = "Free Dentist - your code " . $result . "";
                    $msg = iconv("UTF-8", "Windows-1256", $message);
                    $msg = urlencode($msg);
                    $number = $client->mobile;
                    //    $url="https://apps.gateway.sa/vendorsms/pushsms.aspx?user=FreeDentist&password=0580580373&msisdn=$number&sid=GW%20Active&msg=$msg&fl=0";
                    $n = intval(ltrim($number, '0')); // integer
                    $pfx = '966';
                    $number = $pfx . $n;
                    $url = "http://sms.gateway.sa/sendurl.aspx?user=20093022&pwd=058@freedentist.net&senderid=FREEDENTIST&CountryCode=All&msgtext=$msg&mobileno=$number";
                    // echo file_get_contents($url);


                    if (file_get_contents($url)) {
                        // return response()->json(['status'=>'Code send successefuly']);}
//                       Session::flash('success_message', 'تم إرسـال كلمة المرور الجديدة الى رقم جوالك');

                        return response()->json(['status' => 'Code send successefuly', 'data' => $client]);

                    }
                } else {
                    return response()->json(['status' => 'Error']);

                }
            } else {
                return response()->json(['status' => 'Error']);

            }

        }

        //check otp
        public function LoginFirstTime (Request $request)
        {
            $this->validate($request,
                [


                    'otp' => 'required|numeric',

                ]);
            $dentist = Dentist::where('otp', $request->otp)->first();
            if ($dentist) {
                $dentist->device_id = $request->device_id;
                $dentist->active = 1;

                $dentist->update();
                /* if(Auth::guard('dentist')->attempt(['mobile' => $dentist->mobile,'password' => $dentist->password,'active' => '1'])){*/
                return response()->json(['status' => 'success', 'data' => $dentist]);
                //  }
            } else {

                return response()->json(['Error']);

            }
        }

        public function account (request $request)
        {

            if (!$request->dentist_id) {
                return response()->json(['status' => 'Please Login']);


            }
            $client = Dentist::find($request->dentist_id);
            //	$client = Dentist::get($request->dentist_id)->first();
            $dentist = Dentist::where('id', $request->dentist_id)->first();
            //	$nationalitys  = Nationality::all();
            // echo $dentist->nationality;
            // echo $dentist->hospital;
            $nationalitys = DB::table('nationalities')
                ->where('id', $dentist->nationality)
                ->get();

            //	$hospitals  = Hospital::all();
            $hospitals = Hospital::where('id', $dentist->hospital)->first();
            /*$hospitals = DB::table('hospitals')

          ->where('id',$dentist->hospital)
              ->get();
         */
            $services = DB::table('dentist_calanders')
                ->where('dentist_id', $request->dentist_id)
                ->count();
            return response()->json(['nationalitys' => $nationalitys, 'client' => $client, 'hospitals' => $hospitals, 'services' => $services, 'status' => 'success']);

        }


        public function forgetPassword (Request $request)
        {


            if (!$request->has('mobile')) {
                return response()->json(['status' => 'Missing mobile']);
            }

            $mobile = $request->input('mobile');

            $clientEmail = Dentist::where('mobile', $mobile)
                ->first();
            if (!empty($clientEmail)) {

                //   $data2 = array();
                $data2 = new Dentist();
                $data2->mobile = $mobile;
                $newPassword = rand("100000", "999999");
                $message = "Free Dentist - your new Password " . $newPassword . "";
                $data2->message = $message;

                $data = ['password' => bcrypt($newPassword)];
                DB::table('dentists')
                    ->where('id', $clientEmail->id)
                    ->update($data);
                $msg = iconv("UTF-8", "Windows-1256", $message);
                $msg = urlencode($msg);
                $number = $mobile;
                //     $url="https://apps.gateway.sa/vendorsms/pushsms.aspx?user=FreeDentist&password=0580580373&msisdn=$number&sid=GW%20Active&msg=$msg&fl=0";
                // echo file_get_contents($url);
                $n = intval(ltrim($number, '0')); // integer
                $pfx = '966';
                $number = $pfx . $n;
                $url = "http://sms.gateway.sa/sendurl.aspx?user=20093022&pwd=058@freedentist.net&senderid=FREEDENTIST&CountryCode=All&msgtext=$msg&mobileno=$number";

                if (file_get_contents($url)) {
                    // return response()->json(['status'=>'Code send successefuly']);}
//                       Session::flash('success_message', 'تم إرسـال كلمة المرور الجديدة الى رقم جوالك');

                    return response()->json(['status' => 'success', 'data' => $newPassword]);

                } else {
                    return response()->json(['status' => 'Error']);

                }


            }

        }

        public function forgetPassword2 (Request $request)
        {


            if (!$request->has('email')) {
                return response()->json(['status' => 'Missing Email']);
            }

            $email = $request->input('email');

            $clientEmail = Dentist::where('email', $email)
                ->first();
            if (!empty($clientEmail)) {

                //   $data2 = array();
                $data2 = new Dentist();
                $data2->email = $email;
                $newPassword = rand("100000", "999999");
                $message = "الرقم السرى " . $newPassword . "";
                $data2->message = $message;

                $data = ['password' => bcrypt($newPassword)];
                DB::table('users')
                    ->where('id', $clientEmail->id)
                    ->update($data);
                //Session::flash('success_message', 'تم إرسـال كلمة المرور الجديدة الى بريدك الالكترونى المسجل');
                //	var_dump($users);
                //exit();
                Mail::to($email)->send(new ForgetPassword($data2));

                /* Mail::send('emails.forgetPassword', ['data'=>$data2], function ($message2)  use ($data2){
                      $subject = $data2['message'];
                      //                 $message->from($request->email, $request->name);
                      $message2->to($data2['email'])->subject($subject);
                  });*/

                if (count(Mail::failures()) > 0) {
                    $failuresArr = array();
                    foreach (Mail::failures as $email_address) {
                        $failuresArr[] = $email_address;
                    }
                    return response()->json(['status' => 'Error', 'data' => $failuresArr]);
                } else {
                    return response()->json(['status' => 'success', 'data' => $newPassword]);
                }


            } else {
                return response()->json(['status' => 'Email Not found']);
            }


        }

        public function profileAction (Request $request)
        {

            $client = Dentist::find($request->dentist_id);


            $client->name = $request->name;
            $client->email = $request->email;
            $client->mobile = $request->mobile;


            if ($client) {

                $client->update();

                return response()->json(['status' => 'Updated successefuly', 'data' => $client]);
            } else {
                return response()->json(['status' => 'Error']);
            }


        }


        public function hospitalUpdate (Request $request)
        {

            //    $hospital = Hospital::get();
            $client = Dentist::find($request->dentist_id);
            $hospital = DB::table('hospitals')
                ->where('id', $client->hospital)
                ->get();


            $client->hospital = $request->hospital;


            if ($client) {

                $client->update();

                return response()->json(['status' => 'Updated successefuly', 'data' => $client, 'hospital' => $hospital]);
            } else {
                return response()->json(['status' => 'Error']);
            }


        }


        public function hospitals (Request $request)
        {

            $hospital = Hospital::get();


            return response()->json(['status' => 'success', 'hospital' => $hospital]);


        }


    }















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































